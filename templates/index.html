<!doctype html>
<html>
    <head>
        <title>MailSender</title>
        <style>
            :root {
                --bg-primary: #f0f2f5;
                --bg-secondary: #ffffff;
                --bg-tertiary: #f9fafb;
                --bg-hover: #f3f4f6;
                --text-primary: #1a202c;
                --text-secondary: #374151;
                --text-muted: #4b5563;
                --border-color: #d1d5db;
                --border-light: #e5e7eb;
            }

            html[data-theme="dark"] {
                --bg-primary: #111827;
                --bg-secondary: #1f2937;
                --bg-tertiary: #374151;
                --bg-hover: #4b5563;
                --text-primary: #f3f4f6;
                --text-secondary: #e5e7eb;
                --text-muted: #d1d5db;
                --border-color: #4b5563;
                --border-light: #374151;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    "Helvetica Neue", Arial, sans-serif;
                background: var(--bg-primary);
                min-height: 100vh;
                padding: 20px;
                color: var(--text-primary);
                transition:
                    background 0.3s ease,
                    color 0.3s ease;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: var(--bg-secondary);
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                overflow: hidden;
                animation: slideIn 0.5s ease-out;
            }
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .header {
                background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                padding: 32px 40px;
                color: white;
                border-bottom: 3px solid #1e40af;
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
            }
            .header-content {
                flex: 1;
            }
            .header h1 {
                font-size: 28px;
                font-weight: 700;
                letter-spacing: -0.5px;
            }
            .header p {
                margin-top: 6px;
                opacity: 0.95;
                font-size: 14px;
                font-weight: 400;
            }
            .theme-toggle {
                background: rgba(255, 255, 255, 0.15);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 8px 16px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.3s ease;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                white-space: nowrap;
            }
            .theme-toggle:hover {
                background: rgba(255, 255, 255, 0.25);
                transform: none;
            }
            .content {
                padding: 40px;
            }
            .alert {
                padding: 14px 18px;
                border-radius: 6px;
                margin-bottom: 20px;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 12px;
                animation: fadeIn 0.3s ease-in;
                border-left: 4px solid;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }
            .alert-error {
                background: #fef2f2;
                border-color: #dc2626;
                color: #991b1b;
            }
            .alert-info {
                background: #eff6ff;
                border-color: #2563eb;
                color: #1e40af;
            }
            .alert::before {
                content: "âš ";
                font-size: 18px;
            }
            .alert-info::before {
                content: "â„¹";
            }
            .form-group {
                margin-bottom: 24px;
            }
            .form-label {
                display: block;
                font-weight: 600;
                margin-bottom: 8px;
                color: var(--text-secondary);
                font-size: 30px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                font-size: 14px;
            }
            input[type="file"] {
                display: block;
                width: 100%;
                padding: 14px;
                border: 2px dashed var(--border-color);
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                background: var(--bg-tertiary);
                font-size: 14px;
                color: var(--text-primary);
            }
            input[type="file"]:hover {
                border-color: #2563eb;
                background: #eff6ff;
            }
            input[type="text"],
            input[type="number"],
            textarea {
                width: 100%;
                padding: 12px 16px;
                border: 1px solid var(--border-color);
                border-radius: 6px;
                font-size: 14px;
                transition: all 0.3s ease;
                font-family: inherit;
                background: var(--bg-secondary);
                color: var(--text-primary);
            }
            input[type="text"]:focus,
            input[type="number"]:focus,
            textarea:focus {
                outline: none;
                border-color: #2563eb;
                box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            }
            textarea {
                resize: vertical;
                min-height: 120px;
            }
            .radio-group {
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
                margin-top: 12px;
            }
            .radio-label {
                display: flex;
                align-items: center;
                padding: 10px 16px;
                border: 1px solid var(--border-color);
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s ease;
                background: var(--bg-secondary);
                color: var(--text-primary);
            }
            .radio-label:hover {
                border-color: red;
                background: var(--bg-tertiary);
            }
            .radio-label input[type="radio"] {
                margin-right: 8px;
                cursor: pointer;
                accent-color: red;
            }
            .radio-label input[type="radio"]:checked + span {
                font-weight: 600;
                color: red;
            }
            button {
                padding: 11px 22px;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                font-family: inherit;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                font-size: 13px;
            }
            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }
            button:active {
                transform: translateY(0);
            }
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }
            .btn-primary {
                background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
                color: white;
            }
            .btn-primary:hover {
                box-shadow: 0 4px 16px rgba(30, 64, 175, 0.3);
            }
            .btn-secondary {
                background: var(--bg-tertiary);
                color: var(--text-secondary);
                border: 1px solid var(--border-color);
            }
            .btn-secondary:hover {
                background: var(--bg-hover);
            }
            .btn-success {
                background: #059669;
                color: white;
            }
            .btn-success:hover {
                background: #047857;
                box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3);
            }
            .btn-danger {
                background: #dc2626;
                color: white;
            }
            .btn-danger:hover {
                background: #b91c1c;
                box-shadow: 0 4px 16px rgba(220, 38, 38, 0.3);
            }
            .button-group {
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
                margin-bottom: 24px;
            }
            .range-controls {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 16px;
                background: var(--bg-tertiary);
                border: 1px solid var(--border-light);
                border-radius: 6px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }
            .range-controls input[type="number"] {
                width: 90px;
            }
            .range-controls span {
                font-weight: 500;
                color: var(--text-muted);
            }
            .placeholder-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 12px;
            }
            .placeholder-btn {
                padding: 6px 14px;
                background: var(--bg-secondary);
                color: var(--text-muted);
                border-radius: 4px;
                font-size: 13px;
                border: 1px solid var(--border-color);
            }
            .placeholder-btn:hover {
                background: var(--bg-tertiary);
                border-color: #9ca3af;
                transform: translateY(-1px);
            }
            .section {
                border: 1px solid var(--border-light);
                border-radius: 6px;
                margin-bottom: 16px;
                overflow: hidden;
                background: var(--bg-secondary);
                transition: all 0.3s ease;
            }
            .section:hover {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            }
            .section-header {
                padding: 16px 20px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: var(--bg-tertiary);
                user-select: none;
                transition: all 0.3s ease;
                border-bottom: 1px solid var(--border-light);
            }
            .section-header:hover {
                background: var(--bg-hover);
            }
            .section-title {
                display: flex;
                align-items: center;
                gap: 12px;
                font-weight: 600;
                color: var(--text-primary);
            }
            .toggle {
                font-weight: bold;
                font-size: 18px;
                color: #2563eb;
                transition: transform 0.3s ease;
                width: 20px;
                text-align: center;
            }
            .section-header:hover .toggle {
                transform: scale(1.1);
            }
            .badge {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 700;
            }
            .badge-error {
                background: #fee2e2;
                color: #991b1b;
            }
            .badge-success {
                background: #d1fae5;
                color: #065f46;
            }
            .section-content {
                padding: 20px;
                background: var(--bg-secondary);
            }
            .email-row {
                display: flex;
                align-items: flex-start;
                gap: 12px;
                padding: 12px;
                margin-bottom: 6px;
                border-radius: 4px;
                transition: all 0.2s ease;
                line-height: 1.6;
                border-left: 3px solid transparent;
            }
            .email-row:hover {
                background: var(--bg-tertiary);
                border-left-color: #2563eb;
            }
            .email-row input[type="checkbox"] {
                margin-top: 4px;
                width: 18px;
                height: 18px;
                cursor: pointer;
                accent-color: #2563eb;
            }
            .email-text {
                flex: 1;
                word-break: break-word;
                color: var(--text-secondary);
            }
            .email-text b {
                color: blue;
                margin-right: 8px;
                font-weight: 700;
            }
            .error {
                color: #991b1b;
            }
            .hidden {
                display: none;
            }
            .logs-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                z-index: 1000;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(3px);
                animation: fadeIn 0.3s ease-in;
            }
            .logs-container {
                background: var(--bg-secondary);
                width: 100vw;
                max-width: none;
                height: 100vh;
                border-radius: 8px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                display: flex;
                flex-direction: column;
                overflow: hidden;
                animation: slideIn 0.3s ease-out;
            }
            .logs-header {
                padding: 20px 24px;
                background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                color: white;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 3px solid #1e40af;
            }
            .logs-header h3 {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
            }
            .close-btn {
                background: rgba(255, 255, 255, 0.15);
                color: white;
                border: 1px solid rgba(255, 255, 255, 0.3);
                padding: 8px 18px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: all 0.3s ease;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            .close-btn:hover {
                background: rgba(255, 255, 255, 0.25);
                transform: none;
            }
            .logs-frame {
                flex: 1;
                border: none;
                width: 100%;
                background: var(--bg-secondary);
            }
            @media (max-width: 768px) {
                .content {
                    padding: 20px;
                }
                .header {
                    padding: 20px;
                    flex-direction: column;
                    gap: 12px;
                }
                .header h1 {
                    font-size: 22px;
                }
                .theme-toggle {
                    width: 100%;
                    text-align: center;
                }
                .button-group {
                    flex-direction: column;
                }
                .button-group button {
                    width: 100%;
                }
                .range-controls {
                    flex-direction: column;
                    align-items: stretch;
                }
                .range-controls input[type="number"] {
                    width: 100%;
                }
            }
        </style>
    </head>
    <body>
        <button type="button" class="btn-secondary showLogsBtn">
            View Current / Previous Logs</button
        ><br /><br />
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <h1>MailSender</h1>
                    <p>Professional Bulk Email Management System</p>
                </div>
                <button id="themeToggle" class="theme-toggle">
                    ðŸŒ™ Dark Mode
                </button>
            </div>

            <div class="content">
                {% if not mail %}
                <div class="alert alert-error">
                    Email address not found in the environment. Please configure your email settings<code>MAILSENDER_SMTP_MAIL</code>.
                </div>
                {% endif %} {% if not provider %}
                <div class="alert alert-error">
                    SMTP Provider not detected. Please verify your email configuration.
                </div>
                {% else %}
                <div class="alert alert-info">
                    SMTP Provider: <strong>{{ provider }}</strong>
                </div>
                {% endif %} {% if not password %}
                <div class="alert alert-error">
                    APP Password not found in the environment. Please set your application password<code>MAILSENDER_SMTP_MAIL_APP_PASSWORD</code>.
                </div>
                {% endif %}

                <div class="form-group">
                    <label class="form-label">Upload Email List ( <a href="/dataformat">See Example / Rules Of Data Format</a> )</label>
                    <input type="file" id="fileInput" accept=".csv,.json,.xlsx" />
                </div>

                <div id="fileoption"></div>

                <form id="message" style="display: none">
                    <div class="form-group">
                        <label class="form-label">Email Subject</label>
                        <input
                            type="text"
                            id="subjectbox"
                            placeholder="Enter your email subject here..."
                        />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Message Content</label>
                        <textarea
                            id="messagebox"
                            placeholder="Compose your message... Use placeholder buttons below to insert dynamic content."
                        ></textarea>
                        <div id="keys" class="placeholder-buttons"></div>
                    </div>
                </form>

                <div id="emailControls" style="display: none">
                    <div class="range-controls">
                        <span>Select Range:</span>
                        <input
                            type="number"
                            id="rangeStart"
                            min="1"
                            placeholder="From"
                        />
                        <span>to</span>
                        <input
                            type="number"
                            id="rangeEnd"
                            min="1"
                            placeholder="To"
                        />
                        <button
                            type="button"
                            id="selectRange"
                            class="btn-secondary"
                        >
                            Apply Range
                        </button>
                    </div>

                    <div class="button-group">
                        <button
                            type="button"
                            id="selectAll"
                            class="btn-success"
                        >
                            Select All
                        </button>
                        <button
                            type="button"
                            id="deselectAll"
                            class="btn-secondary"
                        >
                            Deselect All
                        </button>
                        {% if not provider or not password or not mail %}
                        <button
                            type="button"
                            id="submit"
                            class="btn-primary"
                            disabled
                        >
                            Send Emails
                        </button>
                        {% else %}
                        <button type="button" id="submit" class="btn-primary">
                            Send Emails
                        </button>
                        {% endif %}
                        <button type="button" class="btn-secondary showLogsBtn">
                            View Logs
                        </button>
                    </div>
                </div>

                <div id="showemails"></div>
            </div>
        </div>

        <div id="logsOverlay" class="logs-overlay">
            <div class="logs-container">
                <div class="logs-header">
                    <h3>ðŸ“§ Email Delivery Logs</h3>
                    <button class="close-btn" id="closeLogsBtn">âœ• Close</button>
                </div>
                <iframe id="logsFrame" class="logs-frame"></iframe>
            </div>
        </div>

        <script>
    // Theme management
    function initTheme() {
        const savedTheme = localStorage.getItem("theme") || "light";
        document.documentElement.setAttribute("data-theme", savedTheme);
        updateThemeButton(savedTheme);
    }

    function updateThemeButton(theme) {
        const btn = document.getElementById("themeToggle");
        if (theme === "dark") {
            btn.textContent = "â˜€ï¸ Light Mode";
        } else {
            btn.textContent = "ðŸŒ™ Dark Mode";
        }
    }

    function toggleTheme() {
        const currentTheme =
            document.documentElement.getAttribute("data-theme") ||
            "light";
        const newTheme = currentTheme === "light" ? "dark" : "light";
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        updateThemeButton(newTheme);
    }

    document
        .getElementById("themeToggle")
        .addEventListener("click", toggleTheme);

    // Initialize theme on page load
    initTheme();

    // --- FIX STARTS HERE ---

    const $ = (id) => document.getElementById(id);
    const select = (q) => document.querySelectorAll(q);
    const post = (url, fd) =>
        fetch(url, { method: "POST", body: fd }).then((r) => r.json());

    let emailColumn, timer;
    // FIX 1: Track selection by unique Index ID, not by Email address
    let selectedSet = new Set();

    function reset() {
        $("fileoption").innerHTML =
            $("showemails").innerHTML =
            $("keys").innerHTML =
                "";
        $("message").style.display = $("emailControls").style.display =
            "none";
        $("messagebox").value = "";
        selectedSet.clear();
    }

    function openLogs() {
        const overlay = $("logsOverlay");
        const frame = $("logsFrame");
        frame.src = "/show_logs";
        overlay.style.display = "flex";
    }

    function closeLogs() {
        const overlay = $("logsOverlay");
        const frame = $("logsFrame");
        overlay.style.display = "none";
        frame.src = "about:blank";
    }

    document.querySelectorAll(".showLogsBtn").forEach((btn) => {
        btn.onclick = openLogs;
    });

    $("closeLogsBtn").onclick = closeLogs;

    $("logsOverlay").onclick = (e) => {
        if (e.target === $("logsOverlay")) closeLogs();
    };

    document.addEventListener("keydown", (e) => {
        if (
            e.key === "Escape" &&
            $("logsOverlay").style.display === "flex"
        )
            closeLogs();
    });

    $("fileInput").onchange = async () => {
        reset();
        const fd = new FormData();
        fd.append("file", fileInput.files[0]);
        const cols = await post("/file", fd);
        $("fileoption").innerHTML = `
            <div class="form-group">
                <label class="form-label">Select Email Column</label>
                <div class="radio-group">
                    ${cols.map((c) => `<label class="radio-label"><input type="radio" name="col" value="${c}"><span>${c}</span></label>`).join("")}
                </div>
            </div>`;
    };

    $("fileoption").onchange = async (e) => {
        if (!e.target.value) return;
        emailColumn = e.target.value;
        const fd = new FormData();
        fd.append("emailoption", emailColumn);
        render(await post("/showemails", fd));
        $("message").style.display = "block";
    };

    $("keys").onclick = (e) => {
        if (e.target.tagName !== "BUTTON") return;
        const t = $("messagebox");
        const k = `$(${e.target.dataset.key})$`;
        t.focus();
        const p = t.selectionStart ?? t.value.length;
        t.value = t.value.slice(0, p) + k + t.value.slice(p);
        const newPos = p + k.length;
        t.setSelectionRange(newPos, newPos);
        t.dispatchEvent(new Event("input", { bubbles: true }));
    };

    $("messagebox").oninput = () => {
        clearTimeout(timer);
        timer = setTimeout(async () => {
            if (!emailColumn) return;
            const fd1 = new FormData();
            fd1.append("message", $("messagebox").value);
            await fetch("/editmessage", { method: "POST", body: fd1 });
            const fd2 = new FormData();
            fd2.append("emailoption", emailColumn);
            render(await post("/showemails", fd2));
        }, 300);
    };

    // FIX 2: Checkbox change listener uses unique dataset.index
    $("showemails").addEventListener("change", (e) => {
        if (!e.target.classList.contains("cb")) return;
        const idx = e.target.dataset.index; // Use Index instead of Email
        e.target.checked
            ? selectedSet.add(idx)
            : selectedSet.delete(idx);
    });

    $("showemails").addEventListener("click", (e) => {
        const header = e.target.closest(".section-header");
        if (!header) return;
        const target = $(header.dataset.target);
        const icon = header.querySelector(".toggle");
        target.classList.toggle("hidden");
        icon.textContent = target.classList.contains("hidden")
            ? "+"
            : "âˆ’";
    });

    function render(data) {
        $("emailControls").style.display = "block";
        $("keys").innerHTML = data.allkeys
            .map(
                (k) =>
                    `<button type="button" class="placeholder-btn" data-key="${k}">${k}</button>`,
            )
            .join(" ");

        const valid = [],
            error = [],
            placeholderError = [];
        data.emails.forEach((email, i) => {
            const message = data.messages[i] || "";
            // Keep track of index (i) for unique identification
            const row = { email, msg: message, idx: i };
            if (message.startsWith("placeholder_error:"))
                placeholderError.push(row);
            else if (email.includes("ERROR:")) error.push(row);
            else valid.push(row);
        });

        const renderRows = (rows, isError = false) =>
            rows
                .map((r) => {
                    // FIX 3: Check against Index (r.idx + 1)
                    const rowId = (r.idx + 1).toString();
                    const checked = selectedSet.has(rowId)
                        ? "checked"
                        : "";
                    return `<div class="email-row ${isError ? "error" : ""}">
                    ${isError ? "" : `<input type="checkbox" class="cb" data-email="${r.email}" data-message="${r.msg}" data-index="${rowId}" ${checked}>`}
                    <span class="email-text"><b>${rowId}.</b> ${r.email} - ${r.msg}</span>
                </div>`;
                })
                .join("");

        $("showemails").innerHTML = `
            <div class="section">
                <div class="section-header" data-target="errorSection">
                    <div class="section-title">
                        <span class="toggle">+</span>
                        <span>Error (Invalid / Missing) Emails</span>
                        <span class="badge badge-error">${error.length}</span>
                    </div>
                </div>
                <div id="errorSection" class="section-content hidden">
                    ${error.length > 0 ? renderRows(error, true) : '<p style="color: #6b7280;">No errors found</p>'}
                </div>
            </div>
            <div class="section">
                <div class="section-header" data-target="validSection">
                    <div class="section-title">
                        <span class="toggle">âˆ’</span>
                        <span>Valid Emails</span>
                        <span class="badge badge-success">${valid.length}</span>
                    </div>
                </div>
                <div id="validSection" class="section-content">
                    ${valid.length > 0 ? renderRows(valid) : '<p style="color: #6b7280;">No valid emails found</p>'}
                </div>
            </div>`;
    }

    // FIX 4: Update Select All/None/Range to use Index
    $("selectAll").onclick = () => {
        select(".cb").forEach((c) => {
            c.checked = true;
            selectedSet.add(c.dataset.index);
        });
    };

    $("deselectAll").onclick = () => {
        select(".cb").forEach((c) => {
            c.checked = false;
            selectedSet.delete(c.dataset.index);
        });
    };

    $("selectRange").onclick = () => {
        const s = parseInt($("rangeStart").value) - 1;
        const e = parseInt($("rangeEnd").value) - 1;
        const boxes = [...select(".cb")];
        if (
            isNaN(s) ||
            isNaN(e) ||
            s < 0 ||
            e >= boxes.length ||
            s > e
        ) {
            alert("Invalid range. Please check your input.");
            return;
        }
        for (let i = s; i <= e; i++) {
            boxes[i].checked = true;
            selectedSet.add(boxes[i].dataset.index);
        }
    };

    $("submit").onclick = async () => {
        if (!$("messagebox").value.trim()) {
            alert(
                "Message cannot be empty. Please enter your email content.",
            );
            return;
        }
        if (selectedSet.size === 0) {
            alert("Please select at least one email recipient.");
            return;
        }

        // FIX 5: CRITICAL CHANGE
        // Instead of an Object {} (which deletes duplicates), we use an Array []
        const selectedEmails = [];
        select(".cb:checked").forEach((c) => {
            selectedEmails.push({
                email: c.dataset.email,
                data: [Number(c.dataset.index), c.dataset.message]
            });
        });

        const fd = new FormData();
        fd.append("subject", $("subjectbox").value);
        // This sends an ARRAY of objects now
        fd.append("selected_mails", JSON.stringify(selectedEmails));

        const r = await fetch("/selectemails", {
            method: "POST",
            body: fd,
        });
        openLogs();
        const result = await r.json();
        alert(result.status || "Emails sent successfully!");
        $("showLogsBtn").style.display = "inline-block";
        openLogs();
    };
</script>
    </body>
</html>
