<!doctype html>
<html>
    <head>
        <title>MailSender</title>

        <style>
            .email-row {
                display: flex;
                align-items: center;
                gap: 6px;
                margin: 2px 0;
                line-height: 1.2;
                white-space: pre-wrap;
            }

            .email-row input {
                margin: 0;
            }

            button {
                margin-right: 6px;
            }

            .range-controls {
                margin: 8px 0;
            }

            .range-controls input {
                width: 60px;
            }

            .section {
                border: 1px solid #ccc;
                margin-top: 10px;
                padding: 6px;
            }

            .section-header {
                font-weight: bold;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 6px;
                user-select: none;
            }

            .section-content {
                margin-top: 6px;
            }

            .hidden {
                display: none;
            }

            .error {
                color: red;
            }

            .logs-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: none;
                z-index: 1000;
                align-items: center;
                justify-content: center;
            }

            .logs-container {
                background: white;
                width: 90%;
                max-width: 900px;
                height: 80%;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            .logs-header {
                padding: 12px 16px;
                background: #f5f5f5;
                border-bottom: 1px solid #ddd;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .logs-header h3 {
                margin: 0;
                font-size: 18px;
            }

            .close-btn {
                background: #dc3545;
                color: white;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                font-weight: bold;
            }

            .close-btn:hover {
                background: #c82333;
            }

            .logs-frame {
                flex: 1;
                border: none;
                width: 100%;
                background: white;
            }
        </style>
    </head>

    <body>
        <h1>MailSender</h1>

        {% if not mail %}
        <p>Email address not found in the environment</p>
        {% endif %} {% if not provider %}
        <p>
            The SMTP Provider was not found from your environment email. Please
            change or check your Email.
        </p>
        {% else %}
        <p>SMTP Provider = {{ provider }}</p>
        {% endif %} {% if not password %}
        <p>APP Password not found in the environment</p>
        {% endif %}

        <input type="file" id="fileInput" accept=".csv,.json" />
        <div id="fileoption"></div>

        <form id="message" style="display: none">
            <br />Enter the subject:<br />
            <input type="text" id="subjectbox" style="width: 800px" />
            <br /><br />

            Enter the message:<br />
            <textarea id="messagebox" rows="6" cols="100"></textarea>
            <br /><br />

            <div id="keys"></div>
        </form>

        <div id="emailControls" style="display: none">
            <div class="range-controls">
                From <input type="number" id="rangeStart" min="1" /> To
                <input type="number" id="rangeEnd" min="1" />
                <button type="button" id="selectRange">Select Range</button>
            </div>

            <button type="button" id="selectAll">Select All</button>
            <button type="button" id="deselectAll">Deselect All</button>
            <button type="button" id="submit">Submit</button>
            <button type="button" id="showLogsBtn">Show Logs</button>
        </div>

        <div id="showemails"></div>

        <!-- Logs Overlay -->
        <div id="logsOverlay" class="logs-overlay">
            <div class="logs-container">
                <div class="logs-header">
                    <h3>Email Logs</h3>
                    <button class="close-btn" id="closeLogsBtn">✕ Close</button>
                </div>
                <iframe id="logsFrame" class="logs-frame"></iframe>
            </div>
        </div>

        <script>
            const $ = (id) => document.getElementById(id);
            const select = (q) => document.querySelectorAll(q);
            const post = (url, fd) =>
                fetch(url, { method: "POST", body: fd }).then((r) => r.json());

            let emailColumn, timer;
            let selectedSet = new Set();

            /* ---------- RESET ---------- */
            function reset() {
                $("fileoption").innerHTML =
                    $("showemails").innerHTML =
                    $("keys").innerHTML =
                        "";

                $("message").style.display = $("emailControls").style.display =
                    "none";

                $("messagebox").value = "";
                selectedSet.clear();
            }

            /* ---------- LOGS MODAL ---------- */
            function openLogs() {
                const overlay = $("logsOverlay");
                const frame = $("logsFrame");

                // Set src to the logs route (Flask will serve it from templates)
                frame.src = "/show_logs";

                overlay.style.display = "flex";
            }

            function closeLogs() {
                const overlay = $("logsOverlay");
                const frame = $("logsFrame");

                // Hide overlay
                overlay.style.display = "none";

                // Completely remove iframe content to stop HTMX polling
                frame.src = "about:blank";
            }

            $("showLogsBtn").onclick = openLogs;
            $("closeLogsBtn").onclick = closeLogs;

            // Close on overlay click
            $("logsOverlay").onclick = (e) => {
                if (e.target === $("logsOverlay")) {
                    closeLogs();
                }
            };

            // Close on ESC key
            document.addEventListener("keydown", (e) => {
                if (
                    e.key === "Escape" &&
                    $("logsOverlay").style.display === "flex"
                ) {
                    closeLogs();
                }
            });

            /* ---------- FILE UPLOAD ---------- */
            $("fileInput").onchange = async () => {
                reset();

                const fd = new FormData();
                fd.append("file", fileInput.files[0]);

                const cols = await post("/file", fd);

                $("fileoption").innerHTML =
                    "<p>Select email column:</p>" +
                    cols
                        .map(
                            (c) =>
                                `<label><input type="radio" name="col" value="${c}"> ${c}</label>`,
                        )
                        .join("");
            };

            /* ---------- COLUMN SELECT ---------- */
            $("fileoption").onchange = async (e) => {
                if (!e.target.value) return;

                emailColumn = e.target.value;

                const fd = new FormData();
                fd.append("emailoption", emailColumn);

                render(await post("/showemails", fd));
                $("message").style.display = "block";
            };

            /* ---------- PLACEHOLDERS ---------- */
            $("keys").onclick = (e) => {
                if (e.target.tagName !== "BUTTON") return;

                const t = $("messagebox");
                const k = `$(${e.target.dataset.key})$`;
                t.focus();
                const p = t.selectionStart ?? t.value.length;

                t.value = t.value.slice(0, p) + k + t.value.slice(p);
                const newPos = p + k.length;
                t.setSelectionRange(newPos, newPos);
                t.dispatchEvent(new Event("input", { bubbles: true }));
            };

            /* ---------- MESSAGE EDIT ---------- */
            $("messagebox").oninput = () => {
                clearTimeout(timer);
                timer = setTimeout(async () => {
                    if (!emailColumn) return;

                    const fd1 = new FormData();
                    fd1.append("message", $("messagebox").value);
                    await fetch("/editmessage", { method: "POST", body: fd1 });

                    const fd2 = new FormData();
                    fd2.append("emailoption", emailColumn);
                    render(await post("/showemails", fd2));
                }, 300);
            };

            /* ---------- CHECKBOX STATE ---------- */
            $("showemails").addEventListener("change", (e) => {
                if (!e.target.classList.contains("cb")) return;

                const email = e.target.dataset.email;
                e.target.checked
                    ? selectedSet.add(email)
                    : selectedSet.delete(email);
            });

            /* ---------- TOGGLE SECTIONS ---------- */
            $("showemails").addEventListener("click", (e) => {
                const header = e.target.closest(".section-header");
                if (!header) return;

                const target = $(header.dataset.target);
                const icon = header.querySelector(".toggle");

                target.classList.toggle("hidden");
                icon.textContent = target.classList.contains("hidden")
                    ? "+"
                    : "−";
            });

            /* ---------- RENDER ---------- */
            function render(data) {
                $("emailControls").style.display = "block";

                $("keys").innerHTML = data.allkeys
                    .map(
                        (k) =>
                            `<button type="button" data-key="${k}">${k}</button>`,
                    )
                    .join(" ");

                const valid = [];
                const error = [];
                const placeholderError = [];

                data.emails.forEach((email, i) => {
                    const message = data.messages[i] || "";

                    const row = {
                        email,
                        msg: message,
                        idx: i,
                    };

                    if (message.startsWith("placeholder_error:")) {
                        placeholderError.push(row);
                    } else if (email.includes("ERROR:")) {
                        error.push(row);
                    } else {
                        valid.push(row);
                    }
                });

                const renderRows = (rows, isError = false) =>
                    rows
                        .map((r) => {
                            const checked = selectedSet.has(r.email)
                                ? "checked"
                                : "";

                            return `<div class="email-row ${isError ? "error" : ""}">
                                ${
                                    isError
                                        ? ""
                                        : `<input type="checkbox" class="cb"
                                            data-email="${r.email}"
                                            data-message="${r.msg}"
                                            ${checked}>`
                                }
                                <span><b>${r.idx + 1}.</b> ${r.email} - ${r.msg}</span>
                            </div>`;
                        })
                        .join("");

                $("showemails").innerHTML = `

                <div class="section">
                    <div class="section-header" data-target="errorSection">
                        <span class="toggle">+</span> Error Emails (${error.length})
                    </div>
                    <div id="errorSection" class="section-content hidden">
                        <p>Invalid or incomplete email</p>
                        ${renderRows(error, true)}
                    </div>
                </div>

                <div class="section">
                    <div class="section-header" data-target="validSection">
                        <span class="toggle">−</span> Valid Emails (${valid.length})
                    </div>
                    <div id="validSection" class="section-content">
                        ${renderRows(valid)}
                    </div>
                </div>
                `;
            }

            /* ---------- CONTROLS ---------- */
            $("selectAll").onclick = () => {
                select(".cb").forEach((c) => {
                    c.checked = true;
                    selectedSet.add(c.dataset.email);
                });
            };

            $("deselectAll").onclick = () => {
                select(".cb").forEach((c) => {
                    c.checked = false;
                    selectedSet.delete(c.dataset.email);
                });
            };

            $("selectRange").onclick = () => {
                const s = parseInt($("rangeStart").value) - 1;
                const e = parseInt($("rangeEnd").value) - 1;
                const boxes = [...select(".cb")];

                if (
                    isNaN(s) ||
                    isNaN(e) ||
                    s < 0 ||
                    e >= boxes.length ||
                    s > e
                ) {
                    alert("Invalid range");
                    return;
                }

                for (let i = s; i <= e; i++) {
                    boxes[i].checked = true;
                    selectedSet.add(boxes[i].dataset.email);
                }
            };

            /* ---------- SUBMIT ---------- */
            $("submit").onclick = async () => {
                if (!$("messagebox").value.trim()) {
                    alert("Message cannot be empty");
                    return;
                }

                if (selectedSet.size === 0) {
                    alert("Select at least one email");
                    return;
                }

                const selectedEmails = {};
                select(".cb:checked").forEach((c) => {
                    selectedEmails[c.dataset.email] = c.dataset.message;
                });

                const fd = new FormData();
                fd.append("subject", $("subjectbox").value);
                fd.append("selected_mails", JSON.stringify(selectedEmails));

                const r = await fetch("/selectemails", {
                    method: "POST",
                    body: fd,
                });

                const result = await r.json();
                alert(result.status || "Done");

                // Show logs button and open logs after submit
                $("showLogsBtn").style.display = "inline-block";
                openLogs();
            };
        </script>
    </body>
</html>
